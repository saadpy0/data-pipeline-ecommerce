<!DOCTYPE html>
<html>
<head>
    <title>E-commerce Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        h1, h2 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            margin: 0 0 20px 0;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Live E-commerce Dashboard</h1>

        <!-- Product Sales and Revenue -->
        <div class="chart-container">
            <h2>Product Performance</h2>
            <canvas id="salesChart"></canvas>
        </div>

        <div class="grid-container">
            <!-- Event Type Distribution -->
            <div class="chart-container">
                <h2>Event Distribution</h2>
                <canvas id="eventPieChart"></canvas>
            </div>

            <!-- Top Users Chart -->
            <div class="chart-container">
                <h2>Top Users by Purchases</h2>
                <canvas id="topUsersChart"></canvas>
            </div>
        </div>

        <!-- Detailed Tables -->
        <div class="grid-container">
            <!-- Product Stats Table -->
            <div class="metric-card">
                <h2>Product Statistics</h2>
                <table>
                    <tr>
                        <th>Product</th>
                        <th>Sales</th>
                        <th>Revenue</th>
                    </tr>
                    {% for row in data %}
                    <tr>
                        <td>{{ row.product_name }}</td>
                        <td>{{ row.total_sales }}</td>
                        <td>${{ row.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- Event Counts Table -->
            <div class="metric-card">
                <h2>Event Counts</h2>
                <table>
                    <tr>
                        <th>Product</th>
                        <th>Event Type</th>
                        <th>Count</th>
                    </tr>
                    {% for event in event_counts %}
                    <tr>
                        <td>{{ event.product_name }}</td>
                        <td>{{ event.event_type }}</td>
                        <td>{{ event.count }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <!-- Top Users Table -->
        <div class="metric-card" style="margin-top: 20px;">
            <h2>Top Users Leaderboard</h2>
            <table>
                <tr>
                    <th>User</th>
                    <th>Total Purchases</th>
                    <th>Total Spent</th>
                    <th>Last Purchase</th>
                </tr>
                {% for user in top_users %}
                <tr>
                    <td>{{ user.user_id }}</td>
                    <td>{{ user.total_purchases }}</td>
                    <td>${{ user.total_spent|floatformat:2 }}</td>
                    <td>{{ user.last_purchase_time }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <script>
        // Product Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: [{% for row in data %}'{{ row.product_name }}',{% endfor %}],
                datasets: [{
                    label: 'Total Sales',
                    data: [{% for row in data %}{{ row.total_sales }},{% endfor %}],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Revenue ($)',
                    data: [{% for row in data %}{{ row.total_revenue }},{% endfor %}],
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Total Sales'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Revenue ($)'
                        }
                    }
                }
            }
        });

        // Event Distribution Pie Chart
        const eventData = {};
        {% for event in event_counts %}
        if (!eventData['{{ event.event_type }}']) {
            eventData['{{ event.event_type }}'] = 0;
        }
        eventData['{{ event.event_type }}'] += {{ event.count }};
        {% endfor %}

        const pieCtx = document.getElementById('eventPieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(eventData),
                datasets: [{
                    data: Object.values(eventData),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // Top Users Chart
        const usersCtx = document.getElementById('topUsersChart').getContext('2d');
        new Chart(usersCtx, {
            type: 'bar',
            data: {
                labels: [{% for user in top_users %}'{{ user.user_id }}',{% endfor %}],
                datasets: [{
                    label: 'Purchases',
                    data: [{% for user in top_users %}{{ user.total_purchases }},{% endfor %}],
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Purchases'
                        }
                    }
                }
            }
        });

        // Auto-refresh
        setInterval(() => {
            window.location.reload();
        }, 10000);
    </script>
</body>
</html>